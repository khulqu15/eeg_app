<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time EEG Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body class="bg-base-200 text-base-content min-h-screen">
    <div class="w-full max-w-7xl mx-auto p-3">
        <div class="grid lg:grid-cols-4 grid-cols-1 gap-3 mt-4">
            <div class="lg:col-span-3 col-span-1">
                <div class="space-y-3">
                    <label class="input input-bordered flex items-center gap-2">
                        Name
                        <input type="text" class="grow" placeholder="Mohammad Khusnul Khuluq" value="Mohammad Khusnul Khuluq"/>
                    </label>
                    <label class="input input-bordered flex items-center gap-2">
                        Class
                        <input type="text" class="grow" placeholder="D4 Teknik Elektronika B" value="D4 Teknik Elektronika B"/>
                    </label>
                    <label class="input input-bordered flex items-center gap-2">
                        NRP
                        <input type="text" class="grow" placeholder="2121600048" value="2121600048"/>
                    </label>
                </div>
            </div>
            <div class="col-span-1">
                <div class="space-y-3">
                    <select id="port-select" class="select select-bordered w-full"></select>
                    <select id="baudrate-select" class="select select-bordered w-full">
                        <option>9600</option>
                        <option>19200</option>
                        <option>38400</option>
                        <option>57600</option>
                        <option selected>115200</option>
                        <option>250000</option>
                    </select>
                <div>
                    <button id="connect-btn" class="btn btn-primary px-8 text-white w-full">Connect</button>
                </div>
                </div>
            </div>
        </div>
    </div>
    <div class="grid lg:grid-cols-4 grid-cols-1 mx-auto gap-4 py-6 px-4">
        <div class="lg:col-span-3">
            <div class="bg-base-100 p-4 rounded-lg shadow">
                <canvas id="eegChart" class="w-full h-96"></canvas>
            </div>
            <div class="bg-base-100 p-4 rounded-lg shadow mt-4">
                <canvas id="eegDerivedChart" class="w-full h-96"></canvas>
            </div>
        </div>
        <div class="space-y-4">
            <div class="p-4 bg-base-100 rounded-xl">
                <h1 class="text-xl font-semibold mb-2">Feature Option</h1>
                <div class="flex gap-3 items-center flex-wrap">
                    <button class="btn btn-primary text-white" onclick="my_modal_4.showModal()">Sampling</button>
                    <button class="btn btn-primary text-white" onclick="exportChartData()">Export Data</button>
                    <button class="btn btn-primary text-white" onclick="zoomChart(0.5)">Zoom+</button>
                    <button class="btn btn-primary text-white" onclick="zoomChart(2)">Zoom-</button>
                </div>
            </div>
            <div class="p-4 bg-base-100 rounded-xl">
                <h1 class="text-xl font-semibold mb-2">Calculation Data</h1>
                <div>
                    <h2 class="text-sm font-bold mb-1">eeg</h2>
                    <div id="eegValuesContainer" class="h-48 overflow-y-auto bg-base-200 rounded p-2 text-sm border border-base-300"></div>
                </div>
                <div class="flex justify-between items-center hidden"><span>Calculate x1</span><span id="x1">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate x2</span><span id="x2">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate ΔT y1</span><span id="deltaY1">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate ΔT y2</span><span id="deltaY2">0</span></div>
                <div class="flex justify-between items-center"><span>Std deviation</span><span id="std">0</span></div>
                <div class="flex justify-between items-center"><span>Std category</span><span id="std_c">0</span></div>

                <div class="flex justify-between items-center"><span>Frequency (Hz)</span><span id="freq">0</span></div>
                <div class="flex justify-between items-center"><span>Amplifier</span><input id="amp_gain" type="number" value="10" readonly class="input input-bordered input-sm w-24"/></div>
                <div class="flex justify-between items-center"><span>Frequency after amp (Hz)</span><span id="freq_amp">0</span></div>

                <div class="flex justify-between items-center"><span>Average</span><span id="avg">0</span></div>
                <div class="flex justify-between items-center"><span>Peak to Peak</span><span id="ptp">0</span></div>
                <div class="flex justify-between items-center"><span>EEG Class</span><span id="eegClass">-</span></div>
            </div>
            <select id="timeRangeSelect" class="select select-bordered w-full mt-2">
                <option value="all" selected>All Time</option>
                <option value="1s">Last 1 Second</option>
                <option value="1m">Last 1 Minute</option>
                <option value="1h">Last 1 Hour</option>
            </select>
            <div class="p-4 bg-base-100 rounded-xl">
                <h1 class="text-xl font-semibold mb-2">Formulation</h1>
                <div>
                    <div>
                        <span>Alpha</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">8 – 13 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>α</sub> = ∑ |X(f)|² ; 8 ≤ f ≤ 13</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Beta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">13 – 30 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>β</sub> = ∑ |X(f)|² ; 13 ≤ f ≤ 30</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Delta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">0.5 – 4 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>δ</sub> = ∑ |X(f)|² ; 0.5 ≤ f ≤ 4</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Theta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">4 – 8 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>θ</sub> = ∑ |X(f)|² ; 4 ≤ f ≤ 8</kbd></p>
                    </div>
                </div>
                
            </div> 
        </div>
        <dialog id="my_modal_4" class="modal">
            <div class="modal-box w-11/12 max-w-5xl">
                <h3 class="text-lg font-bold">Sampling Signal</h3>
                <div class="mt-4">
                    <canvas id="samplingChart" class="w-full h-64"></canvas>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between"><span>Total Sample Points:</span><span id="samplingPoints">0</span></div>
                    <div class="flex justify-between"><span>Estimated Frequency (Hz):</span><span id="samplingFreq">0</span></div>
                </div>
                <div class="modal-action">
                <form method="dialog">
                    <button class="btn">OK!</button>
                </form>
                </div>
            </div>
        </dialog>
    </div>
    <script>
        const MAX_DATA_POINTS = 60;
        const ctx = document.getElementById('eegChart').getContext('2d');
        const ctx2 = document.getElementById('eegDerivedChart').getContext('2d');
        
        const eegSamples = {
            "Non-Stimulated EEG Signal (Healthy)": [
                {
                "x": 0.0,
                "y": 4.514
                },
                {
                "x": 0.1,
                "y": -0.799
                },
                {
                "x": 0.2,
                "y": -1.609
                },
                {
                "x": 0.3,
                "y": 5.468
                },
                {
                "x": 0.4,
                "y": -2.824
                },
                {
                "x": 0.5,
                "y": 3.984
                },
                {
                "x": 0.6,
                "y": 4.902
                },
                {
                "x": 0.7,
                "y": -2.751
                },
                {
                "x": 0.8,
                "y": -1.969
                },
                {
                "x": 0.9,
                "y": 0.666
                },
                {
                "x": 1.0,
                "y": 3.474
                },
                {
                "x": 1.1,
                "y": -0.465
                },
                {
                "x": 1.2,
                "y": 1.517
                },
                {
                "x": 1.301,
                "y": 2.176
                },
                {
                "x": 1.401,
                "y": -0.952
                },
                {
                "x": 1.501,
                "y": -4.583
                },
                {
                "x": 1.601,
                "y": 0.844
                },
                {
                "x": 1.701,
                "y": 1.594
                },
                {
                "x": 1.801,
                "y": -3.731
                },
                {
                "x": 1.901,
                "y": -9.313
                },
                {
                "x": 2.001,
                "y": 1.929
                },
                {
                "x": 2.101,
                "y": 1.01
                },
                {
                "x": 2.201,
                "y": -2.841
                },
                {
                "x": 2.301,
                "y": 6.139
                },
                {
                "x": 2.401,
                "y": -6.053
                },
                {
                "x": 2.501,
                "y": -4.489
                },
                {
                "x": 2.601,
                "y": 2.0
                },
                {
                "x": 2.701,
                "y": 1.263
                },
                {
                "x": 2.801,
                "y": 4.907
                },
                {
                "x": 2.901,
                "y": -3.628
                },
                {
                "x": 3.001,
                "y": 5.332
                },
                {
                "x": 3.101,
                "y": -2.597
                },
                {
                "x": 3.201,
                "y": 5.06
                },
                {
                "x": 3.301,
                "y": 3.345
                },
                {
                "x": 3.401,
                "y": 1.695
                },
                {
                "x": 3.501,
                "y": -14.552
                },
                {
                "x": 3.601,
                "y": 0.389
                },
                {
                "x": 3.701,
                "y": 1.169
                },
                {
                "x": 3.802,
                "y": -9.458
                },
                {
                "x": 3.902,
                "y": -4.412
                },
                {
                "x": 4.002,
                "y": -1.286
                },
                {
                "x": 4.102,
                "y": 3.117
                },
                {
                "x": 4.202,
                "y": 5.416
                },
                {
                "x": 4.302,
                "y": 0.877
                },
                {
                "x": 4.402,
                "y": -1.491
                },
                {
                "x": 4.502,
                "y": 0.029
                },
                {
                "x": 4.602,
                "y": -3.372
                },
                {
                "x": 4.702,
                "y": -11.103
                },
                {
                "x": 4.802,
                "y": -1.825
                },
                {
                "x": 4.902,
                "y": -1.176
                },
                {
                "x": 5.002,
                "y": 0.962
                },
                {
                "x": 5.102,
                "y": 2.446
                },
                {
                "x": 5.202,
                "y": 12.359
                },
                {
                "x": 5.302,
                "y": 1.363
                },
                {
                "x": 5.402,
                "y": -5.788
                },
                {
                "x": 5.502,
                "y": -0.379
                },
                {
                "x": 5.602,
                "y": -4.062
                },
                {
                "x": 5.702,
                "y": -6.513
                },
                {
                "x": 5.802,
                "y": 8.355
                },
                {
                "x": 5.902,
                "y": -0.258
                },
                {
                "x": 6.002,
                "y": 4.633
                },
                {
                "x": 6.102,
                "y": -1.091
                },
                {
                "x": 6.202,
                "y": 4.126
                },
                {
                "x": 6.303,
                "y": -4.982
                },
                {
                "x": 6.403,
                "y": -2.792
                },
                {
                "x": 6.503,
                "y": -4.479
                },
                {
                "x": 6.603,
                "y": 1.839
                },
                {
                "x": 6.703,
                "y": 3.915
                },
                {
                "x": 6.803,
                "y": -0.273
                },
                {
                "x": 6.903,
                "y": -1.189
                },
                {
                "x": 7.003,
                "y": 8.58
                },
                {
                "x": 7.103,
                "y": 0.556
                },
                {
                "x": 7.203,
                "y": -3.328
                },
                {
                "x": 7.303,
                "y": 1.588
                },
                {
                "x": 7.403,
                "y": 2.854
                },
                {
                "x": 7.503,
                "y": -2.778
                },
                {
                "x": 7.603,
                "y": -0.368
                },
                {
                "x": 7.703,
                "y": -4.072
                },
                {
                "x": 7.803,
                "y": -1.441
                },
                {
                "x": 7.903,
                "y": -2.985
                },
                {
                "x": 8.003,
                "y": -3.912
                },
                {
                "x": 8.103,
                "y": 0.494
                },
                {
                "x": 8.203,
                "y": -4.323
                },
                {
                "x": 8.303,
                "y": -4.178
                },
                {
                "x": 8.403,
                "y": 1.316
                },
                {
                "x": 8.503,
                "y": 0.693
                },
                {
                "x": 8.603,
                "y": 6.245
                },
                {
                "x": 8.703,
                "y": 5.471
                },
                {
                "x": 8.804,
                "y": 3.337
                },
                {
                "x": 8.904,
                "y": -0.525
                },
                {
                "x": 9.004,
                "y": -4.433
                },
                {
                "x": 9.104,
                "y": 1.484
                },
                {
                "x": 9.204,
                "y": 3.151
                },
                {
                "x": 9.304,
                "y": -2.59
                },
                {
                "x": 9.404,
                "y": 2.059
                },
                {
                "x": 9.504,
                "y": 8.714
                },
                {
                "x": 9.604,
                "y": -3.236
                },
                {
                "x": 9.704,
                "y": -2.86
                },
                {
                "x": 9.804,
                "y": -3.904
                },
                {
                "x": 9.904,
                "y": -2.555
                }
            ],
            "Non-Stimulated EEG Signal (Migraineur)": [
                {
                "x": 0.0,
                "y": -1.509
                },
                {
                "x": 0.1,
                "y": 4.119
                },
                {
                "x": 0.2,
                "y": -2.944
                },
                {
                "x": 0.3,
                "y": -7.138
                },
                {
                "x": 0.4,
                "y": 1.661
                },
                {
                "x": 0.5,
                "y": -0.914
                },
                {
                "x": 0.6,
                "y": -3.02
                },
                {
                "x": 0.7,
                "y": 5.689
                },
                {
                "x": 0.8,
                "y": 1.18
                },
                {
                "x": 0.9,
                "y": 3.433
                },
                {
                "x": 1.0,
                "y": 4.48
                },
                {
                "x": 1.1,
                "y": 1.21
                },
                {
                "x": 1.2,
                "y": -4.684
                },
                {
                "x": 1.301,
                "y": 1.381
                },
                {
                "x": 1.401,
                "y": -1.672
                },
                {
                "x": 1.501,
                "y": 10.408
                },
                {
                "x": 1.601,
                "y": 0.708
                },
                {
                "x": 1.701,
                "y": -2.214
                },
                {
                "x": 1.801,
                "y": -0.891
                },
                {
                "x": 1.901,
                "y": -4.503
                },
                {
                "x": 2.001,
                "y": -2.786
                },
                {
                "x": 2.101,
                "y": -0.954
                },
                {
                "x": 2.201,
                "y": -5.142
                },
                {
                "x": 2.301,
                "y": -1.52
                },
                {
                "x": 2.401,
                "y": -5.077
                },
                {
                "x": 2.501,
                "y": -0.001
                },
                {
                "x": 2.601,
                "y": -1.346
                },
                {
                "x": 2.701,
                "y": -8.274
                },
                {
                "x": 2.801,
                "y": -5.696
                },
                {
                "x": 2.901,
                "y": 3.649
                },
                {
                "x": 3.001,
                "y": 0.244
                },
                {
                "x": 3.101,
                "y": -0.032
                },
                {
                "x": 3.201,
                "y": -0.968
                },
                {
                "x": 3.301,
                "y": 3.47
                },
                {
                "x": 3.401,
                "y": -1.31
                },
                {
                "x": 3.501,
                "y": -6.27
                },
                {
                "x": 3.601,
                "y": -1.931
                },
                {
                "x": 3.701,
                "y": 7.322
                },
                {
                "x": 3.802,
                "y": 5.463
                },
                {
                "x": 3.902,
                "y": 0.238
                },
                {
                "x": 4.002,
                "y": 8.333
                },
                {
                "x": 4.102,
                "y": -4.586
                },
                {
                "x": 4.202,
                "y": 12.833
                },
                {
                "x": 4.302,
                "y": -2.636
                },
                {
                "x": 4.402,
                "y": -0.127
                },
                {
                "x": 4.502,
                "y": 3.257
                },
                {
                "x": 4.602,
                "y": 1.431
                },
                {
                "x": 4.702,
                "y": -5.499
                },
                {
                "x": 4.802,
                "y": -3.924
                },
                {
                "x": 4.902,
                "y": 1.135
                },
                {
                "x": 5.002,
                "y": -1.159
                },
                {
                "x": 5.102,
                "y": 0.37
                },
                {
                "x": 5.202,
                "y": -4.879
                },
                {
                "x": 5.302,
                "y": 5.173
                },
                {
                "x": 5.402,
                "y": -2.124
                },
                {
                "x": 5.502,
                "y": -11.613
                },
                {
                "x": 5.602,
                "y": -2.014
                },
                {
                "x": 5.702,
                "y": -2.557
                },
                {
                "x": 5.802,
                "y": -3.082
                },
                {
                "x": 5.902,
                "y": 2.21
                },
                {
                "x": 6.002,
                "y": -0.56
                },
                {
                "x": 6.102,
                "y": 1.196
                },
                {
                "x": 6.202,
                "y": 1.713
                },
                {
                "x": 6.303,
                "y": -0.747
                },
                {
                "x": 6.403,
                "y": -0.07
                },
                {
                "x": 6.503,
                "y": 2.496
                },
                {
                "x": 6.603,
                "y": -1.676
                },
                {
                "x": 6.703,
                "y": 4.502
                },
                {
                "x": 6.803,
                "y": -1.957
                },
                {
                "x": 6.903,
                "y": -2.11
                },
                {
                "x": 7.003,
                "y": 2.28
                },
                {
                "x": 7.103,
                "y": 1.639
                },
                {
                "x": 7.203,
                "y": 5.353
                },
                {
                "x": 7.303,
                "y": -4.073
                },
                {
                "x": 7.403,
                "y": 1.391
                },
                {
                "x": 7.503,
                "y": -5.287
                },
                {
                "x": 7.603,
                "y": 9.098
                },
                {
                "x": 7.703,
                "y": 2.205
                },
                {
                "x": 7.803,
                "y": -4.403
                },
                {
                "x": 7.903,
                "y": 5.906
                },
                {
                "x": 8.003,
                "y": -3.528
                },
                {
                "x": 8.103,
                "y": 8.664
                },
                {
                "x": 8.203,
                "y": -3.35
                },
                {
                "x": 8.303,
                "y": -3.813
                },
                {
                "x": 8.403,
                "y": -1.581
                },
                {
                "x": 8.503,
                "y": -0.68
                },
                {
                "x": 8.603,
                "y": 3.555
                },
                {
                "x": 8.703,
                "y": -4.762
                },
                {
                "x": 8.804,
                "y": 1.352
                },
                {
                "x": 8.904,
                "y": -9.371
                },
                {
                "x": 9.004,
                "y": -1.343
                },
                {
                "x": 9.104,
                "y": -6.418
                },
                {
                "x": 9.204,
                "y": -0.526
                },
                {
                "x": 9.304,
                "y": 3.004
                },
                {
                "x": 9.404,
                "y": 3.399
                },
                {
                "x": 9.504,
                "y": -3.36
                },
                {
                "x": 9.604,
                "y": 1.631
                },
                {
                "x": 9.704,
                "y": -2.185
                },
                {
                "x": 9.804,
                "y": -2.397
                },
                {
                "x": 9.904,
                "y": -2.157
                }
            ],
            "Flash-Stimulated EEG Signal (Healthy)": [
                {
                "x": 0.0,
                "y": 3.073
                },
                {
                "x": 0.1,
                "y": 7.171
                },
                {
                "x": 0.2,
                "y": -4.26
                },
                {
                "x": 0.3,
                "y": -2.412
                },
                {
                "x": 0.4,
                "y": -5.139
                },
                {
                "x": 0.5,
                "y": 1.051
                },
                {
                "x": 0.6,
                "y": 2.037
                },
                {
                "x": 0.7,
                "y": -2.768
                },
                {
                "x": 0.8,
                "y": -0.167
                },
                {
                "x": 0.9,
                "y": 3.059
                },
                {
                "x": 1.0,
                "y": -6.55
                },
                {
                "x": 1.1,
                "y": 4.299
                },
                {
                "x": 1.2,
                "y": 3.935
                },
                {
                "x": 1.301,
                "y": -6.574
                },
                {
                "x": 1.401,
                "y": -5.814
                },
                {
                "x": 1.501,
                "y": -5.128
                },
                {
                "x": 1.601,
                "y": 7.938
                },
                {
                "x": 1.701,
                "y": -1.198
                },
                {
                "x": 1.801,
                "y": 3.524
                },
                {
                "x": 1.901,
                "y": -11.093
                },
                {
                "x": 2.001,
                "y": 3.659
                },
                {
                "x": 2.101,
                "y": 9.36
                },
                {
                "x": 2.201,
                "y": 1.4
                },
                {
                "x": 2.301,
                "y": -2.014
                },
                {
                "x": 2.401,
                "y": -8.096
                },
                {
                "x": 2.501,
                "y": -6.58
                },
                {
                "x": 2.601,
                "y": -0.816
                },
                {
                "x": 2.701,
                "y": -5.584
                },
                {
                "x": 2.801,
                "y": -0.644
                },
                {
                "x": 2.901,
                "y": -3.71
                },
                {
                "x": 3.001,
                "y": -1.098
                },
                {
                "x": 3.101,
                "y": 4.593
                },
                {
                "x": 3.201,
                "y": -4.189
                },
                {
                "x": 3.301,
                "y": 3.399
                },
                {
                "x": 3.401,
                "y": -3.317
                },
                {
                "x": 3.501,
                "y": 1.643
                },
                {
                "x": 3.601,
                "y": 4.446
                },
                {
                "x": 3.701,
                "y": -3.014
                },
                {
                "x": 3.802,
                "y": 1.462
                },
                {
                "x": 3.902,
                "y": -11.583
                },
                {
                "x": 4.002,
                "y": 3.699
                },
                {
                "x": 4.102,
                "y": -10.476
                },
                {
                "x": 4.202,
                "y": -0.892
                },
                {
                "x": 4.302,
                "y": 0.165
                },
                {
                "x": 4.402,
                "y": 0.091
                },
                {
                "x": 4.502,
                "y": -2.109
                },
                {
                "x": 4.602,
                "y": -0.68
                },
                {
                "x": 4.702,
                "y": -5.109
                },
                {
                "x": 4.802,
                "y": -1.462
                },
                {
                "x": 4.902,
                "y": 0.978
                },
                {
                "x": 5.002,
                "y": -3.174
                },
                {
                "x": 5.102,
                "y": -13.097
                },
                {
                "x": 5.202,
                "y": 3.284
                },
                {
                "x": 5.302,
                "y": -3.472
                },
                {
                "x": 5.402,
                "y": -4.635
                },
                {
                "x": 5.502,
                "y": 3.967
                },
                {
                "x": 5.602,
                "y": 2.146
                },
                {
                "x": 5.702,
                "y": -13.598
                },
                {
                "x": 5.802,
                "y": 2.812
                },
                {
                "x": 5.902,
                "y": 4.911
                },
                {
                "x": 6.002,
                "y": -1.451
                },
                {
                "x": 6.102,
                "y": 0.047
                },
                {
                "x": 6.202,
                "y": 2.898
                },
                {
                "x": 6.303,
                "y": 0.027
                },
                {
                "x": 6.403,
                "y": -2.577
                },
                {
                "x": 6.503,
                "y": 0.798
                },
                {
                "x": 6.603,
                "y": 5.54
                },
                {
                "x": 6.703,
                "y": -4.239
                },
                {
                "x": 6.803,
                "y": 7.06
                },
                {
                "x": 6.903,
                "y": 5.717
                },
                {
                "x": 7.003,
                "y": 4.09
                },
                {
                "x": 7.103,
                "y": -3.512
                },
                {
                "x": 7.203,
                "y": -1.238
                },
                {
                "x": 7.303,
                "y": 0.376
                },
                {
                "x": 7.403,
                "y": -8.547
                },
                {
                "x": 7.503,
                "y": 7.056
                },
                {
                "x": 7.603,
                "y": 1.012
                },
                {
                "x": 7.703,
                "y": -0.996
                },
                {
                "x": 7.803,
                "y": -0.192
                },
                {
                "x": 7.903,
                "y": -3.698
                },
                {
                "x": 8.003,
                "y": -1.904
                },
                {
                "x": 8.103,
                "y": 1.715
                },
                {
                "x": 8.203,
                "y": -0.072
                },
                {
                "x": 8.303,
                "y": -2.571
                },
                {
                "x": 8.403,
                "y": -2.491
                },
                {
                "x": 8.503,
                "y": -0.928
                },
                {
                "x": 8.603,
                "y": 4.197
                },
                {
                "x": 8.703,
                "y": -3.834
                },
                {
                "x": 8.804,
                "y": 0.032
                },
                {
                "x": 8.904,
                "y": -8.036
                },
                {
                "x": 9.004,
                "y": -1.414
                },
                {
                "x": 9.104,
                "y": -6.512
                },
                {
                "x": 9.204,
                "y": -3.08
                },
                {
                "x": 9.304,
                "y": 4.492
                },
                {
                "x": 9.404,
                "y": 1.24
                },
                {
                "x": 9.504,
                "y": 0.058
                },
                {
                "x": 9.604,
                "y": -1.369
                },
                {
                "x": 9.704,
                "y": -4.087
                },
                {
                "x": 9.804,
                "y": 3.163
                },
                {
                "x": 9.904,
                "y": -3.697
                }
            ],
            "Flash-Stimulated EEG Signal (Migraineur)": [
                {
                "x": 0.0,
                "y": 1.155
                },
                {
                "x": 0.1,
                "y": 4.342
                },
                {
                "x": 0.2,
                "y": -0.345
                },
                {
                "x": 0.3,
                "y": 1.906
                },
                {
                "x": 0.4,
                "y": 3.113
                },
                {
                "x": 0.5,
                "y": 8.535
                },
                {
                "x": 0.6,
                "y": 0.611
                },
                {
                "x": 0.7,
                "y": -4.245
                },
                {
                "x": 0.8,
                "y": -3.025
                },
                {
                "x": 0.9,
                "y": 6.375
                },
                {
                "x": 1.0,
                "y": -5.416
                },
                {
                "x": 1.1,
                "y": -10.856
                },
                {
                "x": 1.2,
                "y": 3.175
                },
                {
                "x": 1.301,
                "y": -3.963
                },
                {
                "x": 1.401,
                "y": -1.353
                },
                {
                "x": 1.501,
                "y": -0.997
                },
                {
                "x": 1.601,
                "y": -1.657
                },
                {
                "x": 1.701,
                "y": 4.083
                },
                {
                "x": 1.801,
                "y": 1.228
                },
                {
                "x": 1.901,
                "y": 6.823
                },
                {
                "x": 2.001,
                "y": -3.828
                },
                {
                "x": 2.101,
                "y": -1.337
                },
                {
                "x": 2.201,
                "y": -1.877
                },
                {
                "x": 2.301,
                "y": -4.488
                },
                {
                "x": 2.401,
                "y": -4.504
                },
                {
                "x": 2.501,
                "y": 1.442
                },
                {
                "x": 2.601,
                "y": 4.367
                },
                {
                "x": 2.701,
                "y": 6.697
                },
                {
                "x": 2.801,
                "y": -0.753
                },
                {
                "x": 2.901,
                "y": 0.71
                },
                {
                "x": 3.001,
                "y": -5.786
                },
                {
                "x": 3.101,
                "y": 0.238
                },
                {
                "x": 3.201,
                "y": -0.862
                },
                {
                "x": 3.301,
                "y": 4.197
                },
                {
                "x": 3.401,
                "y": 7.567
                },
                {
                "x": 3.501,
                "y": 3.134
                },
                {
                "x": 3.601,
                "y": 0.458
                },
                {
                "x": 3.701,
                "y": -1.054
                },
                {
                "x": 3.802,
                "y": 1.697
                },
                {
                "x": 3.902,
                "y": 6.03
                },
                {
                "x": 4.002,
                "y": -0.568
                },
                {
                "x": 4.102,
                "y": -8.448
                },
                {
                "x": 4.202,
                "y": 2.397
                },
                {
                "x": 4.302,
                "y": 4.597
                },
                {
                "x": 4.402,
                "y": 0.405
                },
                {
                "x": 4.502,
                "y": -4.133
                },
                {
                "x": 4.602,
                "y": -5.813
                },
                {
                "x": 4.702,
                "y": -12.539
                },
                {
                "x": 4.802,
                "y": -2.474
                },
                {
                "x": 4.902,
                "y": 7.46
                },
                {
                "x": 5.002,
                "y": -1.81
                },
                {
                "x": 5.102,
                "y": -7.902
                },
                {
                "x": 5.202,
                "y": -2.735
                },
                {
                "x": 5.302,
                "y": -6.267
                },
                {
                "x": 5.402,
                "y": 4.721
                },
                {
                "x": 5.502,
                "y": 1.99
                },
                {
                "x": 5.602,
                "y": 1.922
                },
                {
                "x": 5.702,
                "y": -1.202
                },
                {
                "x": 5.802,
                "y": -2.634
                },
                {
                "x": 5.902,
                "y": -1.076
                },
                {
                "x": 6.002,
                "y": 0.961
                },
                {
                "x": 6.102,
                "y": -2.7
                },
                {
                "x": 6.202,
                "y": 4.412
                },
                {
                "x": 6.303,
                "y": -3.154
                },
                {
                "x": 6.403,
                "y": -1.699
                },
                {
                "x": 6.503,
                "y": -1.205
                },
                {
                "x": 6.603,
                "y": 5.007
                },
                {
                "x": 6.703,
                "y": 0.352
                },
                {
                "x": 6.803,
                "y": 2.986
                },
                {
                "x": 6.903,
                "y": -2.849
                },
                {
                "x": 7.003,
                "y": 2.471
                },
                {
                "x": 7.103,
                "y": 2.241
                },
                {
                "x": 7.203,
                "y": 9.324
                },
                {
                "x": 7.303,
                "y": 11.36
                },
                {
                "x": 7.403,
                "y": 7.573
                },
                {
                "x": 7.503,
                "y": -6.875
                },
                {
                "x": 7.603,
                "y": 2.372
                },
                {
                "x": 7.703,
                "y": 1.252
                },
                {
                "x": 7.803,
                "y": -0.236
                },
                {
                "x": 7.903,
                "y": 2.231
                },
                {
                "x": 8.003,
                "y": -5.077
                },
                {
                "x": 8.103,
                "y": -8.254
                },
                {
                "x": 8.203,
                "y": -0.432
                },
                {
                "x": 8.303,
                "y": 1.638
                },
                {
                "x": 8.403,
                "y": -2.655
                },
                {
                "x": 8.503,
                "y": 3.506
                },
                {
                "x": 8.603,
                "y": -1.933
                },
                {
                "x": 8.703,
                "y": 0.623
                },
                {
                "x": 8.804,
                "y": -0.429
                },
                {
                "x": 8.904,
                "y": -1.737
                },
                {
                "x": 9.004,
                "y": 0.121
                },
                {
                "x": 9.104,
                "y": 2.814
                },
                {
                "x": 9.204,
                "y": -3.653
                },
                {
                "x": 9.304,
                "y": 1.959
                },
                {
                "x": 9.404,
                "y": 3.312
                },
                {
                "x": 9.504,
                "y": 1.965
                },
                {
                "x": 9.604,
                "y": -11.132
                },
                {
                "x": 9.704,
                "y": -4.658
                },
                {
                "x": 9.804,
                "y": -0.255
                },
                {
                "x": 9.904,
                "y": -1.778
                }
            ]
        };
        let eegData = [];
        let freqList = [];
        let stdList = [];
        let stdCategoryList = [];
        let freqAfterAmpList = [];
        const samplingCtx = document.getElementById('samplingChart').getContext('2d');
        const samplingChart = new Chart(samplingCtx, {
            type: 'line',
            data: {
                datasets: Object.keys(eegSamples).map((key, i) => ({
                    label: key,
                    data: eegSamples[key],
                    borderColor: ['blue', 'red', 'green', 'orange'][i],
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    tension: 0.3,
                    pointRadius: 0
                }))
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Time (s)' },
                        type: 'linear'
                    },
                    y: {
                        title: { display: true, text: 'Amplitude (μV)' },
                        suggestedMin: -25,
                        suggestedMax: 25
                    }
                },
                plugins: {
                    legend: { display: true, position: 'bottom' }
                }
            }
        });

        const rawEEGFull = [];
        const alphaFull = [];
        const betaFull = [];
        const thetaFull = [];
        const deltaFull = [];
        document.getElementById('samplingPoints').innerText = "100";
        document.getElementById('samplingFreq').innerText = "50";

        const eegChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Raw EEG',
                        data: [],
                        yAxisID: 'yRaw',
                        parsing: false,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Alpha',
                        data: [],
                        yAxisID: 'yAlpha',
                        parsing: false,
                        borderColor: 'green',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Beta',
                        data: [],
                        yAxisID: 'yBeta',
                        parsing: false,
                        borderColor: 'red',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Theta',
                        data: [],
                        yAxisID: 'yDeltaTheta',
                        parsing: false,
                        borderColor: 'purple',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Delta',
                        data: [],
                        yAxisID: 'yDeltaTheta',
                        parsing: false,
                        borderColor: 'orange',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'HH:mm:ss.SSS',
                            unit: 'second',
                            displayFormats: { millisecond: 'HH:mm:ss.SSS' }
                        },
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        title: { display: true, text: 'Time' }
                    },
                    yRaw: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Raw EEG (µV)' },
                        beginAtZero: false
                    },
                    yAlpha: {
                        type: 'linear',
                        position: 'right',
                        offset: true,
                        title: { display: true, text: 'Alpha Power' },
                        grid: { drawOnChartArea: false }
                    },
                    yBeta: {
                        type: 'linear',
                        position: 'right',
                        offset: true,
                        title: { display: true, text: 'Beta Power' },
                        grid: { drawOnChartArea: false }
                    },
                    yDeltaTheta: {
                        type: 'linear',
                        position: 'right',
                        offset: true,
                        title: { display: true, text: 'Delta/Theta Power' },
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'bottom' }
                }
            }
        });

                
        const eegDerivedChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'eeg avg', data: [], borderColor: 'gray', backgroundColor: 'transparent' },
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    y: { beginAtZero: false },
                    x: { display: false }
                }
            }
        });
        
        const fetchData = () => {
            fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                if (data.eeg !== undefined) {
                    updateChart(data.eeg);
                }
            })
            .catch(err => console.error('Fetch error:', err));
        };
        
        let lastAlpha = 0, lastBeta = 0, lastTheta = 0, lastDelta = 0;
        const smoothing = 0.2; // 0.1 - 0.3 recommended
        function randomize(value, factor = 0.1) {
            return value + (Math.random() - 0.5) * factor;
        }
        function updateChart(value) {
            const now = new Date();
            const point = { x: now, y: value };
            rawEEGFull.push(point);
            eegChart.data.datasets[0].data = rawEEGFull.map(p => ({ x: new Date(p.x), y: p.y }));

            const fftWindow = rawEEGFull.slice(-256);
            const bands = calculateEEGPowerBands(fftWindow, 250);
            console.log("FFT Window size:", fftWindow.length);

            if (bands) {
                const smoothing = 0.2;
                const randomize = (v) => v + (Math.random()) * 10;

                const alpha = isNaN(bands.alpha) ? lastAlpha : lastAlpha + (bands.alpha - lastAlpha) * smoothing;
                const beta  = isNaN(bands.beta)  ? lastBeta  : lastBeta  + (bands.beta  - lastBeta)  * smoothing;
                const theta = isNaN(bands.theta) ? lastTheta : lastTheta + (bands.theta - lastTheta) * smoothing;
                const delta = isNaN(bands.delta) ? lastDelta : lastDelta + (bands.delta - lastDelta) * smoothing;

                lastAlpha = alpha;
                lastBeta  = beta;
                lastTheta = theta;
                lastDelta = delta;

                alphaFull.push({ x: now, y: alpha });
                betaFull.push({ x: now, y: beta });
                thetaFull.push({ x: now, y: theta });
                deltaFull.push({ x: now, y: delta });
            }

            eegChart.data.datasets[0].data = rawEEGFull;
            eegChart.data.datasets[1].data = alphaFull;
            eegChart.data.datasets[2].data = betaFull;
            eegChart.data.datasets[3].data = thetaFull;
            eegChart.data.datasets[4].data = deltaFull;

            const scaled = value.toFixed(3);
            const eegValuesDiv = document.getElementById('eegValuesContainer');
            const entry = document.createElement('div');
            entry.textContent = `${now.toLocaleTimeString()} — ${scaled}`;
            eegValuesDiv.appendChild(entry);
            const timestamps = rawEEGFull.map(p => new Date(p.x).getTime());
            const min = Math.min(...timestamps);
            const max = Math.max(...timestamps);
            eegChart.options.scales.x.min = min;
            eegChart.options.scales.x.max = max;
            if (rawEEGFull.length > MAX_DATA_POINTS) {
                rawEEGFull.shift();
                alphaFull.shift();
                betaFull.shift();
                thetaFull.shift();
                deltaFull.shift();
            }

            calculateStatistics(rawEEGFull);
            eegChart.update();
            applyTimeRangeFilter();
        }

        function fft(input) {
            const N = input.length;
            if (N <= 1) return input;

            const even = fft(input.filter((_, i) => i % 2 === 0));
            const odd = fft(input.filter((_, i) => i % 2 === 1));

            const output = new Array(N).fill(0).map(() => ({ re: 0, im: 0 }));
            for (let k = 0; k < N / 2; k++) {
                const t = {
                    re: Math.cos(-2 * Math.PI * k / N),
                    im: Math.sin(-2 * Math.PI * k / N)
                };

                const oddK = odd[k];
                const twiddle = {
                    re: t.re * oddK.re - t.im * oddK.im,
                    im: t.re * oddK.im + t.im * oddK.re
                };

                output[k] = {
                    re: even[k].re + twiddle.re,
                    im: even[k].im + twiddle.im
                };
                output[k + N / 2] = {
                    re: even[k].re - twiddle.re,
                    im: even[k].im - twiddle.im
                };
            }
            return output;
        }

        function estimateSamplingRate(data) {
            if (data.length < 2) return 0;
            let totalDiff = 0;
            for (let i = 1; i < data.length; i++) {
                const t1 = new Date(data[i].x).getTime();
                const t0 = new Date(data[i - 1].x).getTime();
                totalDiff += (t1 - t0);
            }
            const avgDt = totalDiff / (data.length - 1); // in ms
            return 1000 / avgDt; // convert to Hz
        }

       function calculateEEGPowerBands(data, samplingRate = 250) {
            if (data.length === 0) return null;

            const signal = data.map(p => p.y);
            const fftSize = Math.pow(2, Math.floor(Math.log2(signal.length))); // power of 2
            const inputComplex = signal.slice(0, fftSize).map(v => ({ re: v, im: 0 }));

            const spectrum = fft(inputComplex);

            const magnitudes = spectrum.slice(0, fftSize / 2).map(c =>
                Math.sqrt(c.re ** 2 + c.im ** 2)
            );

            const freqRes = samplingRate / fftSize;

            const power = (fStart, fEnd) => {
                const startBin = Math.floor(fStart / freqRes);
                const endBin = Math.ceil(fEnd / freqRes);
                let sum = 0;
                for (let i = startBin; i <= endBin; i++) {
                    sum += magnitudes[i] ** 2;
                }
                return sum;
            };

            return {
                delta: power(0.5, 4),
                theta: power(4, 8),
                alpha: power(8, 13),
                beta: power(13, 30)
            };
        }

        function applyTimeRangeFilter() {
            const selected = document.getElementById('timeRangeSelect').value;
            if (selected === 'all') {
                eegChart.data.datasets[0].data = rawEEGFull;
                eegChart.data.datasets[1].data = alphaFull;
                eegChart.data.datasets[2].data = betaFull;
                eegChart.data.datasets[3].data = thetaFull;
                eegChart.data.datasets[4].data = deltaFull;
                eegChart.update();
                return;
            }

            const now = new Date();
            let rangeMs = 1000;
            if (selected === '1m') rangeMs = 60 * 1000;
            else if (selected === '1h') rangeMs = 60 * 60 * 1000;

            const filterByTime = (arr) =>
                arr.filter(point => now - new Date(point.x) <= rangeMs);

            eegChart.data.datasets[0].data = filterByTime(rawEEGFull);
            eegChart.data.datasets[1].data = filterByTime(alphaFull);
            eegChart.data.datasets[2].data = filterByTime(betaFull);
            eegChart.data.datasets[3].data = filterByTime(thetaFull);
            eegChart.data.datasets[4].data = filterByTime(deltaFull);

            eegChart.update();
        }

        document.getElementById('timeRangeSelect').addEventListener('change', applyTimeRangeFilter);
        
        function calculateStatistics(data) {
            const avg = data.reduce((sum, point) => sum + point.y, 0) / data.length;
            const x1 = data[0]?.x ? new Date(data[0].x).getTime() : 0;
            const x2 = data[data.length - 1]?.x ? new Date(data[data.length - 1].x).getTime() : 0;
            const std = Math.sqrt(data.reduce((sum, point) => sum + Math.pow(point.y - avg, 2), 0) / data.length);
            const ptp = Math.max(...data.map(p => p.y)) - Math.min(...data.map(p => p.y));
            const y1 = data[0]?.y || 0;
            const y2 = data[data.length - 1]?.y || 0;
            const deltaY1 = Math.abs(y1 - avg);
            const deltaY2 = Math.abs(y2 - avg);
            const zeroCrossings = data.reduce((count, val, i, arr) => {
                return (i > 0 && ((arr[i - 1] < avg && val >= avg) || (arr[i - 1] > avg && val <= avg))) ? count + 1 : count;
            }, 0);
            const bands = calculateEEGPowerBands(data);
            let eegClass = '-';
            if (bands) {
                const { delta, theta, alpha, beta } = bands;
                const maxBand = Math.max(delta, theta, alpha, beta);
                if (maxBand === delta) eegClass = 'Delta';
                else if (maxBand === theta) eegClass = 'Theta';
                else if (maxBand === alpha) eegClass = 'Alpha';
                else if (maxBand === beta) eegClass = 'Beta';
            }
            document.getElementById('eegClass').innerText = eegClass;
            const samplingRate = estimateSamplingRate(data);
            const estimatedFrequency = (zeroCrossings / 2) * (samplingRate / data.length);
            const freqAfterAmp = estimatedFrequency * parseFloat(document.getElementById("amp_gain").value) || 1;
            
            // Classification Based on Standard Deviation
            let stdCategory = '';
            if (std < 2) stdCategory = 'Delta';
            else if (std < 4) stdCategory = 'Theta';
            else if (std < 6) stdCategory = 'Alpha';
            else stdCategory = 'Beta';
        
            // Update Derived Chart
            eegDerivedChart.data.labels.push(new Date().toLocaleTimeString());
            eegDerivedChart.data.datasets[0].data.push(avg);
        
            if (eegDerivedChart.data.labels.length > MAX_DATA_POINTS) {
                eegDerivedChart.data.labels.shift();
                eegDerivedChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
        
            eegDerivedChart.update();
        
            document.getElementById('std').innerText = std.toFixed(3);
            document.getElementById('std_c').innerText = stdCategory;
            document.getElementById('freq').innerText = samplingRate.toFixed(3);
            document.getElementById('freq_amp').innerText = samplingRate.toFixed(3);
            document.getElementById('avg').innerText = avg.toFixed(3);
            document.getElementById('ptp').innerText = ptp.toFixed(3);
            document.getElementById('x1').innerText = x1 ? new Date(x1).toLocaleTimeString() : '0';
            document.getElementById('x2').innerText = x2 ? new Date(x2).toLocaleTimeString() : '0';
            document.getElementById('deltaY1').innerText = deltaY1.toFixed(3);
            document.getElementById('deltaY2').innerText = deltaY2.toFixed(3);
            // Storing Values for History
            freqList.push(estimatedFrequency.toFixed(3));
            freqAfterAmpList.push(freqAfterAmp.toFixed(3));
            stdList.push(std.toFixed(3));
            stdCategoryList.push(stdCategory);
        }
        
        // Start Fetching Data Automatically
        setInterval(fetchData, 200);

        function exportChartData() {
            const headers = [
                'Timestamp', 
                'eeg Value', 
                'Frequency (Hz)', 
                'Frequency After Amp (Hz)', 
                'Std Deviation', 
                'Std Category'
            ];
            
            const rows = eegChart.data.labels.map((label, i) => {
                return [
                    label,
                    eegChart.data.datasets[0].data[i] || '',
                    freqList[i] || '',
                    freqAfterAmpList[i] || '',
                    stdList[i] || '',
                    stdCategoryList[i] || ''
                ];
            });
    
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'eeg_data_export.csv';
            link.click();
        }
    
        // Function to Zoom the Chart
        function zoomChart(factor) {
            const data = eegChart.data.datasets[0].data;
            if (data.length < 2) return;

            const times = data.map(d => new Date(d.x).getTime());
            const minTime = Math.min(...times);
            const maxTime = Math.max(...times);
            const center = (minTime + maxTime) / 2;
            const range = (maxTime - minTime) * factor / 2;

            eegChart.options.scales.x.min = center - range;
            eegChart.options.scales.x.max = center + range;

            eegChart.update();
        }

        </script>
        
</body>
</html>
