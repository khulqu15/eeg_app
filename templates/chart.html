<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time EEG Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body class="bg-base-200 text-base-content min-h-screen">
    <div class="w-full max-w-7xl mx-auto p-3">
        <div class="grid lg:grid-cols-4 grid-cols-1 gap-3 mt-4">
            <div class="lg:col-span-3 col-span-1">
                <div class="space-y-3">
                    <label class="input input-bordered flex items-center gap-2">
                        Name
                        <input type="text" class="grow" placeholder="Mohammad Khusnul Khuluq" value="Mohammad Khusnul Khuluq"/>
                    </label>
                    <label class="input input-bordered flex items-center gap-2">
                        Class
                        <input type="text" class="grow" placeholder="D4 Teknik Elektronika B" value="D4 Teknik Elektronika B"/>
                    </label>
                    <label class="input input-bordered flex items-center gap-2">
                        NRP
                        <input type="text" class="grow" placeholder="2121600048" value="2121600048"/>
                    </label>
                </div>
            </div>
            <div class="col-span-1">
                <div class="space-y-3">
                    <select id="port-select" class="select select-bordered w-full"></select>
                    <select id="baudrate-select" class="select select-bordered w-full">
                        <option>9600</option>
                        <option>19200</option>
                        <option>38400</option>
                        <option>57600</option>
                        <option selected>115200</option>
                        <option>250000</option>
                    </select>
                <div>
                    <button id="connect-btn" class="btn btn-primary px-8 text-white w-full">Connect</button>
                </div>
                </div>
            </div>
        </div>
    </div>
    <div class="grid lg:grid-cols-4 grid-cols-1 mx-auto gap-4 py-6 px-4">
        <div class="lg:col-span-3">
            <div class="bg-base-100 p-4 rounded-lg shadow hidden">
                <canvas id="eegChart" class="w-full h-96"></canvas>
            </div>
            <div class="bg-base-100 p-4 rounded-lg shadow mt-4">
                <canvas id="eegDerivedChart" class="w-full h-96"></canvas>
            </div>
        </div>
        <div class="space-y-4">
            <div class="p-4 bg-base-100 rounded-xl">
                <h1 class="text-xl font-semibold mb-2">Feature Option</h1>
                <div class="flex gap-3 items-center flex-wrap">
                    <button class="btn btn-primary text-white hidden" onclick="my_modal_4.showModal()">Sampling</button>
                    <button class="btn btn-primary text-white" onclick="exportChartData()">Export Data</button>
                    <button class="btn btn-primary text-white" onclick="zoomChart(0.5)">Zoom+</button>
                    <button class="btn btn-primary text-white" onclick="zoomChart(2)">Zoom-</button>
                </div>
            </div>
            <div class="p-4 bg-base-100 rounded-xl">
                <h1 class="text-xl font-semibold mb-2">Calculation Data</h1>
                <div>
                    <h2 class="text-sm font-bold mb-1">eeg</h2>
                    <div id="eegValuesContainer" class="h-48 overflow-y-auto bg-base-200 rounded p-2 text-sm border border-base-300"></div>
                </div>
                <div class="flex justify-between items-center hidden"><span>Calculate x1</span><span id="x1">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate x2</span><span id="x2">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate ΔT y1</span><span id="deltaY1">0</span></div>
                <div class="flex justify-between items-center hidden"><span>Calculate ΔT y2</span><span id="deltaY2">0</span></div>
                <div class="flex justify-between items-center"><span>Std deviation</span><span id="std">0</span></div>
                <div class="flex justify-between items-center"><span>Std category</span><span id="std_c">0</span></div>

                <div class="flex justify-between items-center"><span>Frequency (Hz)</span><span id="freq">0</span></div>
                <div class="flex justify-between items-center"><span>Amplifier</span><input id="amp_gain" type="number" value="10" readonly class="input input-bordered input-sm w-24"/></div>
                <div class="flex justify-between items-center"><span>Frequency after amp (Hz)</span><span id="freq_amp">0</span></div>

                <div class="flex justify-between items-center"><span>Average</span><span id="avg">0</span></div>
                <div class="flex justify-between items-center"><span>Peak to Peak</span><span id="ptp">0</span></div>
                <div class="flex justify-between items-center"><span>EEG Class</span><span id="eegClass">-</span></div>
            </div>
            <select id="timeRangeSelect" class="select select-bordered w-full mt-2">
                <option value="1s">Last 1 Second</option>
                <option value="1m">Last 1 Minute</option>
                <option value="1h">Last 1 Hour</option>
            </select>
            <div class="p-4 bg-base-100 rounded-xl hidden">
                <h1 class="text-xl font-semibold mb-2">Formulation</h1>
                <div>
                    <div>
                        <span>Alpha</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">8 – 13 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>α</sub> = ∑ |X(f)|² ; 8 ≤ f ≤ 13</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Beta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">13 – 30 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>β</sub> = ∑ |X(f)|² ; 13 ≤ f ≤ 30</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Delta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">0.5 – 4 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>δ</sub> = ∑ |X(f)|² ; 0.5 ≤ f ≤ 4</kbd></p>
                    </div>
                </div>
                <div>
                    <div>
                        <span>Theta</span>
                        <p class="text-sm mt-1">Frekuensi: <kbd class="kbd kbd-sm">4 – 8 Hz</kbd></p>
                        <p class="text-sm">Rumus: <kbd class="kbd kbd-sm">P<sub>θ</sub> = ∑ |X(f)|² ; 4 ≤ f ≤ 8</kbd></p>
                    </div>
                </div>
                
            </div> 
        </div>
        <dialog id="my_modal_4" class="modal">
            <div class="modal-box w-11/12 max-w-5xl">
                <h3 class="text-lg font-bold">Sampling Signal</h3>
                <div class="mt-4">
                    <canvas id="samplingChart" class="w-full h-64"></canvas>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between"><span>Total Sample Points:</span><span id="samplingPoints">0</span></div>
                    <div class="flex justify-between"><span>Estimated Frequency (Hz):</span><span id="samplingFreq">0</span></div>
                </div>
                <div class="modal-action">
                <form method="dialog">
                    <button class="btn">OK!</button>
                </form>
                </div>
            </div>
        </dialog>
    </div>
    <script>
        const MAX_DATA_POINTS = 300;
        const ctx = document.getElementById('eegChart').getContext('2d');
        const ctx2 = document.getElementById('eegDerivedChart').getContext('2d');
        
        let eegData = [];
        let freqList = [];
        let stdList = [];
        let stdCategoryList = [];
        let freqAfterAmpList = [];

        const eegChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'eeg Data',
                        data: [],
                        parsing: false, // Enable x/y object-based data
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0 // Hide points for smoother eeg line
                    },
                    {
                        label: 'QRS Complex',
                        data: [],
                        parsing: false,
                        borderColor: 'red',
                        backgroundColor: 'red',
                        pointRadius: 5,
                        pointStyle: 'rect',
                        showLine: false
                    },
                    {
                        label: 'P Wave',
                        data: [],
                        parsing: false,
                        borderColor: 'green',
                        backgroundColor: 'green',
                        pointRadius: 5,
                        pointStyle: 'triangle',
                        showLine: false
                    },
                    {
                        label: 'T Wave',
                        data: [],
                        parsing: false,
                        borderColor: 'orange',
                        backgroundColor: 'orange',
                        pointRadius: 5,
                        pointStyle: 'circle',
                        showLine: false
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'HH:mm:ss',
                            unit: 'second',
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'eeg Signal (mV)'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });

        
        const eegDerivedChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'eeg', data: [], borderColor: 'gray', backgroundColor: 'transparent' },
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    y: { beginAtZero: false },
                    x: { display: false }
                }
            }
        });
        
        const fetchData = () => {
            fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                if (data.eeg !== undefined) {
                    updateChart(data.eeg);
                }
            })
            .catch(err => console.error('Fetch error:', err));
        };
        
        function updateChart(value) {
            const point = { x: new Date(), y: value };
            eegChart.data.datasets[0].data.push(point);

            if (eegChart.data.labels.length > MAX_DATA_POINTS) {
                // eegChart.data.labels.shift();
                eegChart.data.datasets[0].data.shift();
            }

            const scaled = (value).toFixed(3);
            const eegValuesDiv = document.getElementById('eegValuesContainer');
            const entry = document.createElement('div');
            entry.textContent = `${point.x.toLocaleTimeString()} — ${scaled}`;
            eegValuesDiv.appendChild(entry);
        
            calculateStatistics(eegChart.data.datasets[0].data);
            eegChart.update();
            applyTimeRangeFilter();
        }
        
        function fft(input) {
            const N = input.length;
            if (N <= 1) return input;

            const even = fft(input.filter((_, i) => i % 2 === 0));
            const odd = fft(input.filter((_, i) => i % 2 === 1));

            const output = new Array(N).fill(0).map(() => ({ re: 0, im: 0 }));
            for (let k = 0; k < N / 2; k++) {
                const t = {
                    re: Math.cos(-2 * Math.PI * k / N),
                    im: Math.sin(-2 * Math.PI * k / N)
                };

                const oddK = odd[k];
                const twiddle = {
                    re: t.re * oddK.re - t.im * oddK.im,
                    im: t.re * oddK.im + t.im * oddK.re
                };

                output[k] = {
                    re: even[k].re + twiddle.re,
                    im: even[k].im + twiddle.im
                };
                output[k + N / 2] = {
                    re: even[k].re - twiddle.re,
                    im: even[k].im - twiddle.im
                };
            }
            return output;
        }

        function estimateSamplingRate(data) {
            if (data.length < 2) return 0;
            let totalDiff = 0;
            for (let i = 1; i < data.length; i++) {
                const t1 = new Date(data[i].x).getTime();
                const t0 = new Date(data[i - 1].x).getTime();
                totalDiff += (t1 - t0);
            }
            const avgDt = totalDiff / (data.length - 1); // in ms
            return 1000 / avgDt; // convert to Hz
        }

       function calculateEEGPowerBands(data, samplingRate = 50) {
            if (data.length === 0) return null;

            const signal = data.map(p => p.y);
            const fftSize = Math.pow(2, Math.floor(Math.log2(signal.length))); // power of 2
            const inputComplex = signal.slice(0, fftSize).map(v => ({ re: v, im: 0 }));

            const spectrum = fft(inputComplex);

            const magnitudes = spectrum.slice(0, fftSize / 2).map(c =>
                Math.sqrt(c.re ** 2 + c.im ** 2)
            );

            const freqRes = samplingRate / fftSize;

            const power = (fStart, fEnd) => {
                const startBin = Math.floor(fStart / freqRes);
                const endBin = Math.ceil(fEnd / freqRes);
                let sum = 0;
                for (let i = startBin; i <= endBin; i++) {
                    sum += magnitudes[i] ** 2;
                }
                return sum;
            };

            return {
                delta: power(0.5, 4),
                theta: power(4, 8),
                alpha: power(8, 13),
                beta: power(13, 30)
            };
        }

        function applyTimeRangeFilter() {
            const selected = document.getElementById('timeRangeSelect').value;
            const now = new Date();

            let rangeMs = 1000; // Default 1s
            if (selected === '1m') rangeMs = 60 * 1000;
            else if (selected === '1h') rangeMs = 60 * 60 * 1000;

            eegChart.data.datasets.forEach(dataset => {
                if (!dataset.data) return;
                dataset.data = dataset.data.filter(point => {
                    if (!point.x) return false;
                    return (now - new Date(point.x)) <= rangeMs;
                });
            });

            eegChart.update();
        }

        document.getElementById('timeRangeSelect').addEventListener('change', applyTimeRangeFilter);
        
        function calculateStatistics(data) {
            const avg = data.reduce((sum, point) => sum + point.y, 0) / data.length;
            const x1 = data[0]?.x ? new Date(data[0].x).getTime() : 0;
            const x2 = data[data.length - 1]?.x ? new Date(data[data.length - 1].x).getTime() : 0;
            const std = Math.sqrt(data.reduce((sum, point) => sum + Math.pow(point.y - avg, 2), 0) / data.length);
            const ptp = Math.max(...data.map(p => p.y)) - Math.min(...data.map(p => p.y));
            const y1 = data[0]?.y || 0;
            const y2 = data[data.length - 1]?.y || 0;
            const deltaY1 = Math.abs(y1 - avg);
            const deltaY2 = Math.abs(y2 - avg);
            const zeroCrossings = data.reduce((count, val, i, arr) => {
                return (i > 0 && ((arr[i - 1] < avg && val >= avg) || (arr[i - 1] > avg && val <= avg))) ? count + 1 : count;
            }, 0);
            const bands = calculateEEGPowerBands(data);
            let eegClass = '-';
            if (bands) {
                const { delta, theta, alpha, beta } = bands;
                const maxBand = Math.max(delta, theta, alpha, beta);
                if (maxBand === delta) eegClass = 'Delta';
                else if (maxBand === theta) eegClass = 'Theta';
                else if (maxBand === alpha) eegClass = 'Alpha';
                else if (maxBand === beta) eegClass = 'Beta';
            }
            document.getElementById('eegClass').innerText = eegClass;
            const samplingRate = estimateSamplingRate(data);
            const estimatedFrequency = (zeroCrossings / 2) * (samplingRate / data.length);
            const freqAfterAmp = estimatedFrequency * parseFloat(document.getElementById("amp_gain").value) || 1;
            
            // Classification Based on Standard Deviation
            let stdCategory = '';
            if (std < 2) stdCategory = 'Delta';
            else if (std < 4) stdCategory = 'Theta';
            else if (std < 6) stdCategory = 'Alpha';
            else stdCategory = 'Beta';
        
            // Update Derived Chart
            eegDerivedChart.data.labels.push(new Date().toLocaleTimeString());
            eegDerivedChart.data.datasets[0].data.push(avg);
        
            if (eegDerivedChart.data.labels.length > MAX_DATA_POINTS) {
                eegDerivedChart.data.labels.shift();
                eegDerivedChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
        
            eegDerivedChart.update();
        
            document.getElementById('std').innerText = std.toFixed(3);
            document.getElementById('std_c').innerText = stdCategory;
            document.getElementById('freq').innerText = samplingRate.toFixed(3);
            document.getElementById('freq_amp').innerText = samplingRate.toFixed(3);
            document.getElementById('avg').innerText = avg.toFixed(3);
            document.getElementById('ptp').innerText = ptp.toFixed(3);
            document.getElementById('x1').innerText = x1 ? new Date(x1).toLocaleTimeString() : '0';
            document.getElementById('x2').innerText = x2 ? new Date(x2).toLocaleTimeString() : '0';
            document.getElementById('deltaY1').innerText = deltaY1.toFixed(3);
            document.getElementById('deltaY2').innerText = deltaY2.toFixed(3);
            // Storing Values for History
            freqList.push(estimatedFrequency.toFixed(3));
            freqAfterAmpList.push(freqAfterAmp.toFixed(3));
            stdList.push(std.toFixed(3));
            stdCategoryList.push(stdCategory);
        }
        
        // Start Fetching Data Automatically
        setInterval(fetchData, 200);

        function exportChartData() {
            const headers = [
                'Timestamp', 
                'eeg Value', 
                'Frequency (Hz)', 
                'Frequency After Amp (Hz)', 
                'Std Deviation', 
                'Std Category'
            ];
            
            const rows = eegChart.data.labels.map((label, i) => {
                return [
                    label,
                    eegChart.data.datasets[0].data[i] || '',
                    freqList[i] || '',
                    freqAfterAmpList[i] || '',
                    stdList[i] || '',
                    stdCategoryList[i] || ''
                ];
            });
    
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'eeg_data_export.csv';
            link.click();
        }
    
        // Function to Zoom the Chart
        function zoomChart(factor) {
            eegChart.options.scales.x.min = Math.max(0, (eegChart.options.scales.x.min || 0) * factor);
            eegChart.options.scales.x.max = Math.min(eegChart.data.labels.length, (eegChart.options.scales.x.max || eegChart.data.labels.length) * factor);
            eegChart.update();
        }
        </script>
        
</body>
</html>
